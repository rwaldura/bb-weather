<html>
  <head>
	<meta charset="UTF-8" />	
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	
	<script type="text/javascript" src="https://code.jscharting.com/latest/jscharting.js"></script>
	<script type="text/javascript" src="https://code.jscharting.com/latest/modules/types.js"></script>

	<script type="text/javascript" src="uom.js"></script>	
	<script type="text/javascript" src="data.js"></script>	
	<script type="text/javascript" src="styling.js"></script>	
	<script type="text/javascript">
/*
 * Functions that manipulate DOM elements.
 */
		
/****************************************************************************/
function showError(message)
{
	console.log("*** ERROR " + message);
	const e = document.getElementById('chart_errors');
	e.textContent = message;
	e.style.display = 'block';
}

function clearError()
{
	const e = document.getElementById('chart_errors');
	e.style.display = 'none';
}

function debugTable(dt)
{
	const t = new google.visualization.Table(document.getElementById('data_debug'));
	t.draw(dt, { showRowNumber: true });
}

/****************************************************************************/
function drawCharts(dt /* datatable */)
{
	if (dt)
	{
		if (!G.currentDataTable) // currentDataTable has never been set
		{
			// only draw the wind rose the first time: 
			// 1- it doesn't change that much, and 
			// 2- it leaks (crashes Chromecast after a few hours)
			drawWindRose(dt);		
		}

		// cache the datatable so we can quickly re-draw it later
		G.currentDataTable = dt;
	} 
	else 
	{
		dt = G.currentDataTable;
	}
	
	const opts = {
		legend: 'none',
		colors: ['#cccccc'], 
		backgroundColor: G.color,
		chartArea: { 
			top: 40, 
			left: 40,
			height: '80%',  // 276
			width: '90%' }, // 570
		titleTextStyle: { fontSize: 16 },
		lineWidth: 0,
		pointsVisible: true,
		pointSize: 20,
		fontName: "Google Sans",
		tooltip: { isHtml: true },
		hAxis: { textStyle: { fontSize: 12 } },
		vAxis: { minValue: 0, textStyle: { fontSize: 12 } },
	};								

	opts.title = 'Now';
	chart2.draw(
		prepWindData(dt, 20 /* 20 minutes */, 1 /* minute */), 
		opts);

	opts.chartArea.width = '95%';
	opts.title = 'This Week';
	chart1.draw(
		prepWindData(dt, 5 * 24 * 60 /* 5 days */, 60 /* 1 hour */), 
		opts);	
		
	console.log("drawn all charts");
}

/****************************************************************************/
function drawWindRose(dt)
{
	const data1 = prepWindRoseData(dt);
	// console.log("d1 = ", data1);
	
	const data2 = JSC.nest() 
      .key('speed') 
      .key('angle') 
      .rollup('percent') 
      .series(data1) 
	  .reverse();
  	// console.log("d2 = ", data2);
	
	renderWindRose(data2);
	
	console.log("rendered wind rose");
}

/****************************************************************************/
function renderWindRose(data) 
{ 
	return JSC.chart('chart3', { 
		series: data,
		debug: false, 
		box_fill: G.color,
		type: 'radar column', 
		title: { 
			label_style_fontFamily: 'Google Sans',
			label_text: 'This Month', 
			label_style_fontSize: 16, 
			label_style_fontWeight: 'bold',
			position: 'left' }, 
		legend: { 
			style_fontFamily: 'Google Sans',
			title_label_text: 'Wind Speed', 
			position: 'right', 
			template: '%icon %name', 
			reversed: false }, 
		defaultSeries_shape_padding: 0.02, 
		yAxis: { 
			defaultTick_label_style_fontFamily: 'Google Sans',
			defaultTick_label_text: '%value%', 
			scale_type: 'stacked', 
			alternateGridFill: 'none' }, 
		xAxis: { 
			scale_range: [0, 360], 
			scale_interval: 45, 
			customTicks: [ 
				{ value: 360, label_text: 'North', label_style_fontFamily: 'Google Sans', label_style_fontWeight: 'bold', label_style_color: '#ff0000' }, 
				{ value:  45, label_text: 'NE',    label_style_fontFamily: 'Google Sans' },
				{ value:  90, label_text: 'East',  label_style_fontFamily: 'Google Sans', label_style_fontWeight: 'bold', label_style_color: '#eeee00' }, 
				{ value: 135, label_text: 'SE',    label_style_fontFamily: 'Google Sans' },
				{ value: 180, label_text: 'South', label_style_fontFamily: 'Google Sans', label_style_fontWeight: 'bold', label_style_color: '#00ff00' },
				{ value: 225, label_text: 'SW',    label_style_fontFamily: 'Google Sans' },
				{ value: 270, label_text: 'West',  label_style_fontFamily: 'Google Sans', label_style_fontWeight: 'bold', label_style_color: '#0000ff' },
				{ value: 315, label_text: 'NW',    label_style_fontFamily: 'Google Sans' } ] }, 
		palette: [ 
			'#c62828', 
			'#ff7043', 
			'#fff176', 
			'#aed581', 
			'#80cbc4', 
			'#bbdefb' ], 
		defaultPoint: { 
			tooltip: '<b>%seriesName MPH</b> %xValue° %yValue%' } }); 
} 

/****************************************************************************/
function updateClock()
{
	const f = new google.visualization.DateFormat({ pattern: "EEEE MMMM d, YYYY h:mm aa" });
	const clock = document.getElementById('clock');
	clock.textContent = f.formatValue(new Date());
}

/****************************************************************************/
function updateInstantMetrics(dt)
{
	const mins = 10; // minutes
	const i = getInstantMetrics(dt, mins);	
	const instant = document.getElementById('instant');
	instant.textContent = `Min: ${formatSpeed(i.min, 1)} 
		— Avg: ${formatSpeed(i.avg, 1)} 
		— Max: ${formatSpeed(i.max, 1)} (last ${mins} minutes)`;
}

/****************************************************************************/
function updateAll(json)
{
	try
	{
		clearError();
		
		const dt = new google.visualization.DataTable(json);
		drawCharts(dt);
		updateInstantMetrics(dt);
		updateClock();
	}
	catch (e)
	{
		showError("Drawing charts: " + e);
	}	
}

/***************************************************************************
 * UNITS_OF_MEASUREMENT is defined in uom.js
 */
function parseSearchParameters()
{
	const params = new URLSearchParams(window.location.search);
	
	const g = {
		color: (params.get("colors") === "muted") ? "#C9B091" : "white",
		speed: UNITS_OF_MEASUREMENT[params.get("speed") || "mph"],
	};

	return g;
}

/***************************************************************************
 * Event handler for unit selector dropdown menu.
 */
function changeSpeedUnit(speedUnit)
{
	G.speed = UNITS_OF_MEASUREMENT[speedUnit];
	drawCharts(/* re-use current datatable */);
	// edit the current URL and add it to the history? 
}

/***************************************************************************
 * main()
 */
// global settings 
const G = parseSearchParameters();
G.request = newDataTableRequest(); // defined in data.js

// refresh charts every minute
// loadChartData() is defined in data.js
setInterval(loadChartData, 66666 /* ms */);

google.charts.load('current', { 'packages': ['corechart', 'table'] });
var chart1, chart2, chart3;
google.charts.setOnLoadCallback(function () {
	chart1 = new google.visualization.AreaChart(
		document.getElementById('chart1'));
	chart2 = new google.visualization.AreaChart(
		document.getElementById('chart2'));
	chart3 = new google.visualization.ColumnChart(
		document.getElementById('chart3'));

	loadChartData();
});	
	</script>
	<link rel="stylesheet" href="styles.css">
  </head>
  <body>
	<div id="charts">
		<div id="chart1"></div>
		<div id="chart2"></div>
		<div id="chart3"></div>
	</div>
	<div id="footer">
		<select id="speed_unit" onchange="changeSpeedUnit(this.value)">
			<option value="mph">Miles per hour</option>
			<option value="kmh">Kilometers per hour</option>
			<option value="ms">Meters per second</option>
			<option value="knots">Knots</option>
		</select>
		<span id="instant">&nbsp;</span>
		<span id="clock">0</span>		
	</div>				
	<div id="chart_errors">Loading... Please wait</div>
	<div id="data_debug"></div>
  </body>
  <script>
  	document.body.style.backgroundColor = G.color;

	// initialize the selector on page load
	const speedUnitSelector = document.getElementById('speed_unit');
	speedUnitSelector.value = G.speed.unit;
  </script>
</html>
