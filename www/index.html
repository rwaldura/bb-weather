<html>
  <head>
	<meta charset="UTF-8" />
	
    <script type="text/javascript" src="weather.js"></script>	
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">
/****************************************************************************/
function showError(message)
{
	console.log("*** ERROR " + message);
	const e = document.getElementById('chart_errors');
	e.textContent = message;
}

function clearError()
{
	const e = document.getElementById('chart_errors');
	e.textContent = '';
}

function debug(data)
{
	const t = new google.visualization.Table(document.getElementById('data_debug'));
	t.draw(data, { showRowNumber: true });
}

/***************************************************************************
 * Style the datapoint to indicate wind direction.
 * See https://developers.google.com/chart/interactive/docs/points#customizing-individual-points
 */
function dir2style(dt, row, col, period /* minutes */)
{
	const dir = dt.getValue(row, col);
	const color = dir2color(dir);
	return `point { 
		shape-type: star;
		shape-sides: 2;
		shape-rotation: ${dir}; 
		fill-color: ${color} }`;
}

/***************************************************************************
 * See https://developers.google.com/chart/interactive/docs/reference#dateformat
 */
function format_timestamp(ts /* Date */, period /* minutes */)
{
	var format;
	if (period < 60) // show minutes
		format = "h:mm aa";
	else // show day of week and hour
		format = "EEE MMM d, h aa";

	const f = new google.visualization.DateFormat({ pattern: format });
	return f.formatValue(ts);
}

/***************************************************************************
 * Custom tooltip
 * See https://developers.google.com/chart/interactive/docs/customizing_tooltip_content#customizing-html-content
 */
function tooltip(dt, row, ts_col, dir_col, revs_col, period /* minutes */)
{
	const d = format_direction(dt.getValue(row, dir_col));
	const t = format_timestamp(dt.getValue(row, ts_col), period);
	const s = format_speed(dt.getValue(row, revs_col), period);
	return `<div class="tooltip">
		<span class="timestamp">${t}</span><br>
		${d}<br> 
		${s.mph} mph
		</div>`;
}

/****************************************************************************/
function to_mph(dt, row, col, T)
{
	const P = dt.getValue(row, col);
	const ws = wind_speed(P, T);
	return ws.mph;
}

/****************************************************************************/
// data is defined as:
//
// column index 0
// id: "tstamp",
// type: "number"
// 
// column index 1
// id: "period",
// type: "number"
// 
// column index 2
// id: "direction",
// type: "number"
// 
// column index 3
// id: "revs",
// type: "number"		
function groupWindData(dt, lookback, period)
{
	lookback *= 60;	// to seconds
	period *= 60;	// to seconds
	
	// from above
	var dir_col_idx = 2;	// column index for wind direction in degrees
	var revs_col_idx = 3;	// column index for count of revolutions

	var view = new google.visualization.DataView(dt);

	// WHERE period=1 AND tstamp > 1 day ago
	view.setRows(view.getFilteredRows([
		{ column: 1, value: 1 }, // WHERE period = 1 (always)
		{ column: 0, minValue: view.getColumnRange(0).max - lookback }]));

	if (period > 1 * 60) // further grouping is necessary
	{
		// quantize into time windows of "period" seconds
		const grouped = google.visualization.data.group(
			view,
			// group by timestamp over the period given
			[{ column: 0,
				modifier: function(t) { return period * Math.floor(t / period) }, 
				type: 'number' }],
			// aggregate columns: AVG(dir), SUM(revs)
			{ column: 2,
				aggregation: google.visualization.data.avg, 
				type: 'number' },
			{ column: 3, 
				aggregation: google.visualization.data.sum, 
				type: 'number' });
			
		view = new google.visualization.DataView(grouped);
		dir_col_idx = 1;
		revs_col_idx = 2;
	}

	view.setColumns([
		{ id: 'date_time', // timestamp, as a Date object
			type: 'date', 
			calc: function(dt, row) { const ts = dt.getValue(row, 0); return new Date(ts * 1000) } }, 
		{ id: 'speed_mph', 
			label: "Wind Speed",
			type: 'number', 
			calc: function(dt, row) { return to_mph(dt, row, revs_col_idx, period) } }, 
		{ id: 'point_style', 
			role: 'style',
			type: 'string', 
			calc: function(dt, row) { return dir2style(dt, row, dir_col_idx, period / 60) } },
		{ id: 'point_tooltip', 
			role: 'tooltip', 
			properties: { html: true },
			type: 'string', 
			calc: function(dt, row) { return tooltip(dt, row, 1, dir_col_idx, revs_col_idx, period / 60) } } ]);

	return view;	
}

/****************************************************************************/
function drawCharts(dt /* datatable */)
{
	const opts = {
		legend: 'none',
		colors: ['#cccccc'], 
		lineWidth: 0,
		pointsVisible: true,
		pointSize: 24,
		fontName: "Google Sans",
		tooltip: { isHtml: true },
		vAxis: { minValue: 0 } };								

	opts.title = 'Last Hour';
	chart1.draw(
		groupWindData(dt, 1 * 60 /* 1 hour */, 1 /* minute */), 
		opts);

	opts.title = 'Last Day';
	chart2.draw(
		groupWindData(dt, 26 * 60 /* ~1 day */, 60 /* minutes */), 
		opts);

	opts.title = 'Last Week';
	chart3.draw(
		groupWindData(dt, 7 * 24 * 60 /* 1 week */, 2 * 60 /* 2 hours */), 
		opts);	
}

/****************************************************************************/
function loadDataAndUpdateCharts(json)
{
	try
	{
		clearError();
		drawCharts(new google.visualization.DataTable(json));
	}
	catch (e)
	{
		showError("Error drawing charts: " + e.message);
	}	
}

/***************************************************************************
 * main()
 */
const xhr = new XMLHttpRequest();
xhr.responseType = "json";
xhr.onerror = function(e) {
	showError("Error loading chart data: " + e.message);
};
xhr.onload = function() {
	if (xhr.status == 200 // HTTP OK
		&& xhr.response)
	{
		loadDataAndUpdateCharts(xhr.response);
	}
	else
	{
		showError("Error loading chart data: status=" + xhr.status + " resp=" + xhr.response);
	}
};

function refreshCharts()
{
	xhr.open("GET", "getDataTable.cgi", true);
	xhr.send();
	// next, the onload handler gets called
}

// refresh charts every minute
setInterval(refreshCharts, 66666 /* ms */);

google.charts.load('current', { 'packages': ['corechart','table'] });
var chart1, chart2, chart3;
google.charts.setOnLoadCallback(function () {
	chart1 = new google.visualization.AreaChart(
		document.getElementById('chart_speed_last_hour'));
	chart2 = new google.visualization.AreaChart(
		document.getElementById('chart_speed_last_day'));
	chart3 = new google.visualization.AreaChart(
		document.getElementById('chart_speed_last_week'));

	refreshCharts();
});	
    </script>
	<style>
	    body, table, div, tr, td {
			border: 0;
	        margin: 0;
			padding: 0;
			font-family: "Google Sans";
	    }
		.tooltip {
			padding: 5;
			font-size: 14;
		}
		.tooltip .timestamp {
			font-weight: bold;
		}
		.tooltip .alt_units {
			font-size: 10;
		}	
		#chart_errors {
			font-size: 20;
			color: red;
			text-align: center;
		}	
	</style>
  </head>
  <body bgcolor="white">
	<div id="chart_errors">Loading... Please wait</div>
	<!-- sized to fit on 720p screen: 1280x720 -->
    <div id="chart_speed_last_hour" style="width: 1280; height: 360;"></div>				
    <div id="chart_speed_last_day" style="width: 1280; height: 360;"></div>				
    <div id="chart_speed_last_week" style="width: 1280; height: 360;"></div>				
	<div id="data_debug"></div>
  </body>
</html>
