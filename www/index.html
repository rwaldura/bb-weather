<html>
  <head>
	<meta charset="UTF-8" />
	
    <script type="text/javascript" src="uom.js"></script>	
    <script type="text/javascript" src="data.js"></script>	
    <script type="text/javascript" src="styling.js"></script>	
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <script type="text/javascript">
/*
 * Functions that manipulate DOM elements.
 */
		
/****************************************************************************/
function showError(message)
{
	console.log("*** ERROR " + message);
	const e = document.getElementById('chart_errors');
	e.textContent = message;
	e.style.display = 'block';
}

function clearError()
{
	const e = document.getElementById('chart_errors');
	e.style.display = 'none';
}

function debug(dt)
{
	const t = new google.visualization.Table(document.getElementById('data_debug'));
	t.draw(dt, { showRowNumber: true });
}

/****************************************************************************/
function drawCharts(dt /* datatable */)
{
	if (dt)
	{
		G.currentDataTable = dt;
	} 
	else 
	{
		dt = G.currentDataTable;
	}
	
	const opts = {
		legend: 'none',
		colors: ['#cccccc'], 
		backgroundColor: G.color,
		chartArea: { left: 50, top: 40, width: '90%', height: '80%' },
		// theme: "maximized", // bof
		titleTextStyle: { fontSize: 14 },
		lineWidth: 0,
		pointsVisible: true,
		pointSize: 20,
		fontName: "Google Sans",
		tooltip: { isHtml: true },
		vAxis: { minValue: 0 } };								

	opts.title = 'Now';
	chart1.draw(
		groupWindData(dt, 20 /* 20 minutes */, 1 /* minute */), 
		opts);

	opts.title = 'Today';
	chart2.draw(
		groupWindData(dt, 26 * 60 /* ~1 day */, 60 /* minutes */), 
		opts);

	opts.title = 'This Week';
	chart3.draw(
		groupWindData(dt, 7 * 24 * 60 /* 1 week */, 2 * 60 /* 2 hours */), 
		opts);	
}

/****************************************************************************/
function updateClock()
{
	const f = new google.visualization.DateFormat({ pattern: "EEEE MMMM d, YYYY h:mm aa" });
	const now = f.formatValue(new Date());	
	
	const clock = document.getElementById('clock');
	clock.textContent = now;
}

/****************************************************************************/
function updateInstantMetrics(dt)
{
	// find current max, mean, min
	
	const instant = document.getElementById('instant');
	instant.textContent = "xxx";
}

/****************************************************************************/
function updateAll(json)
{
	try
	{
		clearError();
		
		const dt = new google.visualization.DataTable(json);
		drawCharts(dt);
		
		updateInstantMetrics(dt);
		updateClock();
	}
	catch (e)
	{
		showError("Drawing charts: " + e);
	}	
}

/***************************************************************************
 * UNITS_OF_MEASUREMENT is defined in uom.js
 */
function parseSearchParameters()
{
	const params = new URLSearchParams(window.location.search);
	
	const g = {
		color: (params.get("colors") === "muted") ? "#C9B091" : "white",
		speed: UNITS_OF_MEASUREMENT[params.get("speed") || "mph"],
	};

	return g;
}

/***************************************************************************
 * Event handler for unit selector dropdown menu.
 */
function changeSpeedUnit(speedUnit)
{
	G.speed = UNITS_OF_MEASUREMENT[speedUnit];
	drawCharts(/* re-use current datatable */);
	// edit the current URL and add it to the history? 
}

/***************************************************************************
 * main()
 */
// global settings 
const G = parseSearchParameters();
G.request = newDataTableRequest(); // defined in data.js

// refresh charts every minute
// loadChartData() is defined in data.js
setInterval(loadChartData, 66666 /* ms */);

google.charts.load('current', { 'packages': ['corechart', 'table'] });
var chart1, chart2, chart3;
google.charts.setOnLoadCallback(function () {
	chart1 = new google.visualization.AreaChart(
		document.getElementById('chart1'));
	chart2 = new google.visualization.AreaChart(
		document.getElementById('chart2'));
	chart3 = new google.visualization.AreaChart(
		document.getElementById('chart3'));

	loadChartData();
});	
    </script>
	<style>
body, div, td {
	border: 0;
    margin: 0;
	padding: 0;
	font-family: "Google Sans";
}

.tooltip {
	padding: 5;
	font-size: 14;
}
.tooltip .timestamp {
	font-weight: bold;
}
.tooltip .alt_units {
	font-size: 10;
}	

#chart_errors {
	position: absolute;
	top: 200;
	left: 0;
	width: 100%;
	font-size: 18;
	color: red;
	text-align: center;
}	

#speed_unit {
	font-family: "Google Sans";
	font-size: 12;
	float: left;
}	

/* sized to fit on 720p screen: 1280x720 */
#chart1 {
	width: 640; 
	height: 348;
}
#chart2 {
	width: 640; 
	height: 348;
	position: absolute;
	top: 0;
	left: 640;
}
#chart3 {
	width: 1280; 
	height: 348;
}
#footer {
	margin: 10;
	font-size: 12;
	height: 24;
	text-align: center;
}
#clock {
	float: right;
}
	</style>
  </head>
  <body id="body">
	<div id="chart1"></div>
	<div id="chart2"></div>
	<div id="chart3"></div>
	<div id="footer">
		<select id="speed_unit" onchange="changeSpeedUnit(this.value)">
			<option value="mph">Miles per hour</option>
			<option value="kmh">Kilometers per hour</option>
			<option value="ms">Meters per second</option>
			<option value="knots">Knots</option>
		</select>
		<span id="instant">&nbsp;</span>
		<span id="clock">0</span>		
	</div>				
	<div id="chart_errors">Loading... Please wait</div>
	<div id="data_debug"></div>
  </body>
  <script>
  	document.body.style.backgroundColor = G.color;

	// initialize the selector on page load
	const speedUnitSelector = document.getElementById('speed_unit');
	speedUnitSelector.value = G.speed.unit;
  </script>
</html>
