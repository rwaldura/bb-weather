<html>
  <head>
	<meta charset="UTF-8" />
	
	<!-- for testing: load TEST_DATA -->
    <script type="text/javascript" src="t.json"></script>	
	
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
// readonly MPH_KMH=1.609 # convert miles per hour to kilometers per hour
// readonly MPH_MS=2.2352 # convert miles per hour to meters per second
// CAST(ROUND(speed * $MPH_KMH) AS INTEGER) AS speed_kmh,
// CAST(ROUND(speed / $MPH_MS ) AS INTEGER) AS speed_ms
			// CASE
			// 	WHEN direction IS NULL THEN NULL
			//     WHEN direction < 22  THEN 'N'
			//     WHEN direction < 67  THEN 'NE'
			//     WHEN direction < 112 THEN 'E'
			//     WHEN direction < 157 THEN 'SE'
			//     WHEN direction < 212 THEN 'S'
			//     WHEN direction < 247 THEN 'SW'
			//     WHEN direction < 292 THEN 'W'
			//     WHEN direction < 337 THEN 'NW'
			//     ELSE 'N'
			// END AS heading,
		
		function _getData(f_drawChart) 
		{
			var q = google.visualization.Query("getDataTable.cgi"); // same host
			q.send(
				function (response) { // google.visualization.QueryResponse
					if (response.isError()) 
					{
						console.log("query failed" + response.getMessage());
						google.visualization.errors.addErrorFromQueryResponse(
							document.getElementById("chart_errors"),
							response);
					} 
					else 
					{
						f_drawChart(response.getDataTable());
					}
				 }
			);			
		}
		
		function getData_fixed()
		{
			return new google.visualization.DataTable(TEST_DATA);			
		}
		
		function debug(data)
		{
			var t = new google.visualization.Table(document.getElementById('data_debug'));
			t.draw(data, {showRowNumber: true});			
		}

		function floor10min(tstamp)
		{
			return Math.floor(tstamp / (10 * 60));
		}
		
		function chartWindSpeedLastDay(data)
		{
			let view = new google.visualization.DataView(data);
			
			// display wind speed for the last day, every 10 minutes
			view.setRows(view.getFilteredRows( [
				{ column: 2, value: 1 }, // WHERE period = 1
				{ column: 0, minValue: view.getColumnRange(0).max - 24 * 60 * 60 } ])); // AND tstamp > 1 day ago
			
			// quantize into 10-min windows
			let view1 = google.visualization.data.group(
				view, 
				[0, { column: 0,  // keep column 0 as the start of 10-min window
					modifier: floor10min, 
					type: 'number' }],
				[{ column: 1, 
					aggregation: google.visualization.data.min, 
					type:'Date' },
				{ column: 4, 
					aggregation: google.visualization.data.avg, 
					type:'number' }]);
			
			debug(view1);
					
			var chart = new google.visualization.AreaChart(document.getElementById('chart_speed_last_day'));
			chart.draw(view1, {
				title: 'Over the last bay, by 10 minutes',
			});						
		}

		// compute wind speed in MPH
		// calculate wind speed in miles per hour according to:
		// const K = 9 / (4 * T)
		// var V = K * P		
		function to_mph(data, rowNum)
		{
			var revs = data.getValue(rowNum, 4); // revs is column #4 in this data table
			return (9 * revs) / (4 * 60);
		}
		
		function chartWindSpeedLastHour(data)
		{
			var view = new google.visualization.DataView(data);
			
			// display wind speed for the last hour, minute by minute
			view.setRows(view.getFilteredRows( [
				{ column: 2, value: 1 }, // WHERE period = 1
				{ column: 0, minValue: view.getColumnRange(0).max 
					- 1 * 60 * 60 } // AND tstamp > 1 hour ago
			]));
			view.setColumns([1,  // timestamp from table
				{ id:'speed_mph', calc:to_mph, type:'number', label:"Wind Speed (MPH)" }
			]);
			
			var chart = new google.visualization.AreaChart(document.getElementById('chart_speed_last_hour'));
			chart.draw(view, {
				title: 'Over the last hour, by minute',
			});						
		}
		
	    google.charts.load('current', {'packages':['corechart','table']});
	    google.charts.setOnLoadCallback(
			function () {
				var data = getData_fixed();
				chartWindSpeedLastHour(data);
				// chartWindSpeedLastDay(data);
		    });			
    </script>
  </head>
  <body>
	<div id="chart_errors"></div>
	<!-- sized to fit on 720p screen: 1280x720 -->
	<div id="all_charts">
		<table>
			<tr>
				<td>
				    <div id="chart_speed_last_hour" style="width: 640; height: 360;"></div>				
				</td>
				<td>
					<div id="chart_dir_last_hour" style="width: 640; height: 360;"></div>				
				</td>
			</tr>
			<tr>
				<td>
				    <div id="chart_speed_last_day" style="width: 640; height: 360;"></div>				
				</td>
				<td>
					<div id="chart_60min" style="width: 640; height: 360;"></div>				
				</td>
			</tr>
		</table>
	</div>
	<p>Timeperiod ending <span id="current_datim"></span></p>
	<div id="data_debug"></div>
  </body>
  <script type="text/javascript">
	document.getElementById('current_datim').textContent = new Date();  	
  </script>
</html>
