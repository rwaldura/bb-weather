<html>
  <head>
	<meta charset="UTF-8" />
	
	<!-- for testing: load TEST_DATA -->
    <script type="text/javascript" src="http://beaglebone.lan:8888/getDataTable.cgi"></script>	
	
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
// readonly MPH_KMH=1.609 # convert miles per hour to kilometers per hour
// readonly MPH_MS=2.2352 # convert miles per hour to meters per second
// CAST(ROUND(speed * $MPH_KMH) AS INTEGER) AS speed_kmh,
// CAST(ROUND(speed / $MPH_MS ) AS INTEGER) AS speed_ms
			// CASE
			// 	WHEN direction IS NULL THEN NULL
			//     WHEN direction < 22  THEN 'N'
			//     WHEN direction < 67  THEN 'NE'
			//     WHEN direction < 112 THEN 'E'
			//     WHEN direction < 157 THEN 'SE'
			//     WHEN direction < 212 THEN 'S'
			//     WHEN direction < 247 THEN 'SW'
			//     WHEN direction < 292 THEN 'W'
			//     WHEN direction < 337 THEN 'NW'
			//     ELSE 'N'
			// END AS heading,
		
		function _getData(f_drawChart) 
		{
			var q = google.visualization.Query("getDataTable.cgi"); // same host
			q.send(
				function (response) { // google.visualization.QueryResponse
					if (response.isError()) 
					{
						console.log("query failed" + response.getMessage());
						google.visualization.errors.addErrorFromQueryResponse(
							document.getElementById("chart_errors"),
							response);
					} 
					else 
					{
						f_drawChart(response.getDataTable());
					}
				 }
			);			
		}
		
		function getData_fixed()
		{
			return new google.visualization.DataTable(DATA_TABLE);			
		}
		
		function debug(data)
		{
			var t = new google.visualization.Table(document.getElementById('data_debug'));
			t.draw(data, {showRowNumber: true});			
		}

		// compute wind speed in MPH
		// calculate wind speed in miles per hour according to:
		// V = 9P / 4T
		function to_mph(data, row, col, T)
		{
			var P = data.getValue(row, col)
			var V = (9 * P) / (4 * T)
			// console.log("r=" + row + " c=" + col + " P=" + P + " V=" + V)
			return V
		}

		// return styling for the point, to indicate direction
		function dir2style(data, row, col, period)
		{
			return 'point { size: 18; shape-type: star; fill-color: #a52714; }';
		}
		
		// data is defined as:
		// column index 0
		// id: "tstamp",
		// type: "number"
		// 
		// column index 1
		// id: "datim",
		// type: "datetime"
		// 
		// column index 2
		// id: "period",
		// type: "number"
		// 
		// column index 3
		// id: "direction",
		// type: "number"
		// 
		// column index 4
		// id: "revs",
		// type: "number"		
		function groupWindData(data, lookback, period)
		{
			lookback *= 60; // in seconds
			period *= 60; // in seconds
			
			// from above
			var dir_col_idx = 3; // column index for wind direction in degrees
			var revs_col_idx = 4; // column index for count of revolutions

			var view = new google.visualization.DataView(data);

			// WHERE period=1 AND tstamp > 1 day ago
			view.setRows(view.getFilteredRows([
				{ column: 2, value: 1 }, // WHERE period = 1 (always)
				{ column: 0, minValue: view.getColumnRange(0).max - lookback }]));

			if (period > 1 * 60) // further grouping is necessary
			{
				// quantize into time windows of "period" seconds
				var grouped = google.visualization.data.group(
					view,
					// group by timestamp over the period given
					[{ column: 0,
						modifier: function(t) { return period * Math.floor(t / period) }, 
						type: 'number' }],
					// aggregate columns: MIN(datim), AVG(dir), SUM(revs)
					[{ column: 1,
						aggregation: google.visualization.data.min, 
						type: 'datetime' },
					{ column: 3,
						aggregation: google.visualization.data.avg, 
						type: 'number' },
					{ column: 4, 
						aggregation: google.visualization.data.sum, 
						type: 'number' }]);
			
				// debug(grouped);
					
				view = new google.visualization.DataView(grouped);
				revs_col_idx = 2;
				dir_col_idx = 3;
			}
			
			view.setColumns([
				1,  // timestamp, as a Date object
				{ id: 'speed_mph', 
					type: 'number', 
					calc: function(d, row) { return to_mph(d, row, revs_col_idx, period) }, 
					label: "Wind Speed (MPH)" },
				{ role: 'style', 
					type: 'string',
					calc: function(d, row) { return dir2style(d, row, dir_col_idx, period) }}]);
			
			debug(view)
					
			return view;			
		}

	    google.charts.load('current', {'packages':['corechart','table']});
	    google.charts.setOnLoadCallback( function() {
			var data = getData_fixed();

			var chart1 = new google.visualization.LineChart(
				document.getElementById('chart_speed_last_hour'));
			chart1.draw(
				groupWindData(data, 1 * 60, 1), {
					title: 'Over the last hour, every minute',
					legend: 'none',
					vAxis: { minValue: 0 }});

			// var chart2 = new google.visualization.AreaChart(
	// 			document.getElementById('chart_speed_last_day'));
	// 		chart2.draw(
	// 			groupWindData(data, 24 * 60, 10), {
	// 				title: 'Over the last day, every 10 minutes',
	// 				legend: 'none',
	// 				vAxis: { minValue: 0 }});
	//
	// 		var chart3 = new google.visualization.AreaChart(
	// 			document.getElementById('chart_speed_last_week'));
	// 		chart3.draw(
	// 			groupWindData(data, 7 * 24 * 60, 1 * 60), {
	// 				title: 'Over the last week, every hour',
	// 				legend: 'none',
	// 				vAxis: { minValue: 0 }});
		});			
    </script>
	<style>
	    body, table, div, td {
			border: 0;
	        margin: 0;
			padding: 0;
	    }
	</style>
  </head>
  <body>
	<div id="chart_errors"></div>
	<!-- sized to fit on 720p screen: 1280x720 -->
	<div id="all_charts">
		<table cellpadding="0" ce>
			<tr>
				<td>
				    <div id="chart_speed_last_hour" style="width: 640; height: 360;"></div>				
				</td>
				<td>
					<div id="chart_dir_last_hour" style="width: 640; height: 360;"></div>				
				</td>
			</tr>
			<tr>
				<td>
				    <div id="chart_speed_last_day" style="width: 640; height: 360;"></div>				
				</td>
				<td>
					<div id="chart_60min" style="width: 640; height: 360;"></div>				
				</td>
			</tr>
			<tr>
				<td>
				    <div id="chart_speed_last_week" style="width: 640; height: 360;"></div>				
				</td>
				<td>
					<div id="chart_60min" style="width: 640; height: 360;"></div>				
				</td>
			</tr>
		</table>
	</div>
	<div id="data_debug"></div>
  </body>
</html>
